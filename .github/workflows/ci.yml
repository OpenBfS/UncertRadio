name: CI

on:
  pull_request:
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends build-essential cmake gfortran git ccache libgtk-3-dev libplplot-dev plplot-driver-cairo liblapack-dev python3-sphinx python3-myst-parser

      - name: Configure
        run: |
          cmake -S . -B build -DBUILD_DOCS=ON -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=./install

      - name: Build and install
        run: |
          cmake --build build --target install -j $(nproc)

      - name: Run self tests
        run: |
          if [ -x ./install/bin/UncertRadio ]; then
            ./install/bin/UncertRadio run_tests
          else
            echo "Executable not found: ./install/bin/UncertRadio" && exit 1
          fi
