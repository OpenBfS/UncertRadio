name: Windows build

on:
  # Nightly builds – triggered by the schedule workflow
  workflow_dispatch:
    inputs:
      nightly:
        description: 'Run nightly prerelease'
        required: false
        default: 'false'
  # Release builds – run on tag pushes to main
  push:
    tags:
      - 'v*'          # any tag that starts with “v”
jobs:
  msys2-ucrt64:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    env:
      BUILD_TYPE: Release
    steps:
      - uses: actions/checkout@v6
      - uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            git make mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-toolchain mingw-w64-ucrt-x86_64-gcc-fortran
            mingw-w64-ucrt-x86_64-gtk3 mingw-w64-ucrt-x86_64-plplot
            mingw-w64-ucrt-x86_64-wxwidgets3.2-msw
            mingw-w64-ucrt-x86_64-lapack mingw-w64-ucrt-x86_64-python-sphinx
            mingw-w64-ucrt-x86_64-python-myst-parser
      - name: CI-Build
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=$BUILD_TYPE -DCMAKE_INSTALL_PREFIX=./install
          cmake --build build --target install -j $(nproc)

      - name: run UR (using msys2-ucrt64)
        run: |
          OUTPUT=$(./install/bin/UncertRadio run_tests 2>&1) || true
          echo "$OUTPUT"
          if echo "$OUTPUT" | grep -q "BA-Test finished: no deviations!" && \
             echo "$OUTPUT" | grep -q "STOP 0"; then
            echo "Tests passed"
          else
            echo "Tests failed – see log above"
            exit 1
          fi

      - name: run UR (native)
        shell: cmd
        run: |
          for /f "delims=" %%i in ('.\install\bin\UncertRadio.exe run_tests') do (
            echo %%i
            set "LINE=%%i"
            if "%%i"=="BA-Test finished: no deviations!" set "OK1=1"
            if "%%i"=="STOP 0" set "OK2=1"
          )
          if defined OK1 if defined OK2 (
            echo Tests passed
          ) else (
            echo Tests failed – see output above
            exit /b 1
          )

      - name: Package install directory
        run: |
          # Use the current Git branch name for the archive
          tar -czf "UncertRadio_windows_${{ github.ref_name }}_nightly.tar.gz" -C install .

      - name: Nightly Release
        uses: softprops/action-gh-release@v2
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.nightly == 'true' }}

        with:
          prerelease: true
          name: Nightly_${{ github.ref_name }}
          generate_release_notes: false
          tag_name: Nightly_${{ github.ref_name }}
          files: |
            UncertRadio_windows_${{ github.ref_name }}_nightly.tar.gz

      - name: Tag Release
        if: ${{ startsWith(github.ref, 'refs/tags/') }}
        uses: softprops/action-gh-release@v2
        with:
          prerelease: false
          generate_release_notes: true
          name: Release_${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          files: |
            UncertRadio_windows_${{ github.ref_name }}_nightly.tar.gz